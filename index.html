<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Draft - Matchup Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .config-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .config-section h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            white-space: pre-line;
        }
        
        .success {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            white-space: pre-line;
        }
        
        .gameweek-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .matchup-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .matchup-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .matchup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .team-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
        }
        
        .team-score {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
        }
        
        .matchup-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
        }
        
        .team-lineup {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .player-name {
            font-weight: 500;
            color: #333;
        }
        
        .player-score {
            font-weight: 700;
            color: #667eea;
            min-width: 30px;
            text-align: right;
        }
        
        .vs-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ccc;
        }
        
        .standings-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .standings-card h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .standings-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .standings-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .standings-table tr:hover {
            background: #f8f9fa;
        }
        
        .rank {
            font-weight: 700;
            color: #667eea;
        }
        
        @media (max-width: 768px) {
            .matchup-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .vs-divider {
                display: none;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const FPLDraftApp = () => {
            const [leagueId, setLeagueId] = useState('8308'); // Your league ID
            const [currentGameweek, setCurrentGameweek] = useState(null);
            const [leagueData, setLeagueData] = useState(null);
            const [matchups, setMatchups] = useState([]);
            const [standings, setStandings] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [selectedGameweek, setSelectedGameweek] = useState(null);
            
            const testConnection = async () => {
                setError(null);
                setLoading(true);
                
                try {
                    console.log('Testing API connection...');
                    console.log('League ID:', leagueId);
                    
                    // Test 1: Public endpoint through proxy
                    console.log('Test 1: Trying bootstrap endpoint through proxy...');
                    console.log('Fetching: /api/bootstrap-static');
                    const bootstrapResponse = await fetch('/api/bootstrap-static');
                    console.log('Bootstrap response status:', bootstrapResponse.status);
                    
                    if (!bootstrapResponse.ok) {
                        const errorText = await bootstrapResponse.text();
                        console.log('Bootstrap error response:', errorText);
                        throw new Error('Public API failed - Status: ' + bootstrapResponse.status + ' - ' + errorText);
                    }
                    
                    const bootstrapData = await bootstrapResponse.json();
                    console.log('✅ Proxy and public API work!');
                    console.log('Bootstrap data received:', Object.keys(bootstrapData));
                    
                    // Test 2: League endpoint through proxy
                    console.log('Test 2: Trying league endpoint through proxy...');
                    console.log('Fetching: /api/league/' + leagueId + '/details');
                    const leagueResponse = await fetch(`/api/league/${leagueId}/details`);
                    
                    console.log('League response status:', leagueResponse.status);
                    
                    if (!leagueResponse.ok) {
                        const errorText = await leagueResponse.text();
                        console.log('League error response:', errorText);
                        if (leagueResponse.status === 404) {
                            throw new Error('❌ League not found! Check your League ID (currently: ' + leagueId + ')');
                        } else if (leagueResponse.status === 403 || leagueResponse.status === 401) {
                            throw new Error('❌ League is private and requires authentication. Unfortunately, the proxy cannot access private leagues.');
                        }
                        throw new Error('API returned status: ' + leagueResponse.status + ' - ' + errorText);
                    }
                    
                    const leagueData = await leagueResponse.json();
                    console.log('✅ League data accessible! Everything works.');
                    console.log('League name:', leagueData.league?.name);
                    setError('✅ Connection test passed! You can now click "Load League"');
                    
                } catch (err) {
                    console.error('Connection test failed:', err);
                    if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
                        setError('❌ Network error! Make sure:\n1. The server is running (check the command window)\n2. The URL is http://localhost:8000');
                    } else {
                        setError(err.message);
                    }
                } finally {
                    setLoading(false);
                }
            };
            
            const fetchLeagueData = async () => {
                if (!leagueId) {
                    setError('Please enter a league ID');
                    return;
                }
                
                setLoading(true);
                setError(null);
                
                try {
                    console.log('Fetching league data for league:', leagueId);
                    
                    // Fetch league details through proxy
                    const leagueResponse = await fetch(`/api/league/${leagueId}/details`);
                    
                    console.log('League response status:', leagueResponse.status);
                    
                    if (!leagueResponse.ok) {
                        if (leagueResponse.status === 404) {
                            throw new Error('League not found. Please check your League ID.');
                        } else if (leagueResponse.status === 403 || leagueResponse.status === 401) {
                            throw new Error('This league appears to be private. The app can only access public league data through the proxy.');
                        }
                        throw new Error(`Failed to fetch league data (Status: ${leagueResponse.status})`);
                    }
                    
                    const leagueInfo = await leagueResponse.json();
                    console.log('League data loaded successfully:', leagueInfo);
                    setLeagueData(leagueInfo);
                    
                    // Get current gameweek through proxy
                    const bootstrapResponse = await fetch('/api/bootstrap-static');
                    const bootstrapData = await bootstrapResponse.json();
                    const currentGW = bootstrapData.events.find(e => e.is_current)?.id || 1;
                    console.log('Current gameweek:', currentGW);
                    setCurrentGameweek(currentGW);
                    setSelectedGameweek(currentGW);
                    
                    // Fetch standings
                    setStandings(leagueInfo.standings);
                    
                    // Fetch matchups for current gameweek
                    await fetchGameweekMatchups(leagueId, currentGW, leagueInfo);
                    
                } catch (err) {
                    console.error('Error loading league:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const fetchGameweekMatchups = async (lgId, gameweek, lgData) => {
                try {
                    console.log('Fetching matchups for gameweek:', gameweek);
                    
                    const response = await fetch(`/api/league/${lgId}/details`);
                    const data = await response.json();
                    
                    // Get matches for the gameweek
                    const matches = data.matches.filter(m => m.event === gameweek);
                    console.log('Found matches:', matches.length);
                    
                    // Fetch live scores through proxy
                    const liveResponse = await fetch(`/api/event/${gameweek}/live`);
                    const liveData = await liveResponse.json();
                    console.log('Live data loaded');
                    
                    // Fetch all entry details for this gameweek
                    const matchupsWithDetails = await Promise.all(
                        matches.map(async (match) => {
                            const entry1Response = await fetch(`/api/entry/${match.league_entry_1}/event/${gameweek}`);
                            const entry2Response = await fetch(`/api/entry/${match.league_entry_2}/event/${gameweek}`);
                            
                            const entry1Data = await entry1Response.json();
                            const entry2Data = await entry2Response.json();
                            
                            return {
                                match,
                                entry1: entry1Data,
                                entry2: entry2Data,
                                liveData
                            };
                        })
                    );
                    
                    console.log('All matchup details loaded');
                    setMatchups(matchupsWithDetails);
                } catch (err) {
                    console.error('Error fetching matchups:', err);
                    setError('Error loading matchup details: ' + err.message);
                }
            };
            
            const changeGameweek = (direction) => {
                const newGW = selectedGameweek + direction;
                if (newGW >= 1 && newGW <= 38) {
                    setSelectedGameweek(newGW);
                    fetchGameweekMatchups(leagueId, newGW, leagueData);
                }
            };
            
            const getPlayerScore = (playerId, liveData) => {
                const playerStats = liveData.elements?.[playerId];
                return playerStats?.stats?.total_points || 0;
            };
            
            const calculateTeamScore = (picks, liveData) => {
                return picks.reduce((total, pick) => {
                    const score = getPlayerScore(pick.element, liveData);
                    return total + (score * pick.multiplier);
                }, 0);
            };
            
            const getTeamName = (entryId) => {
                const standing = standings.find(s => s.league_entry === entryId);
                return standing?.entry_name || 'Unknown Team';
            };
            
            const getPlayerName = (playerId, liveData) => {
                const player = liveData.elements?.[playerId];
                return player ? `${player.web_name}` : 'Unknown Player';
            };
            
            return (
                <div className="app-container">
                    <div className="header">
                        <h1>⚽ FPL Draft Matchup Tracker</h1>
                        <p>Side-by-side matchup view for your Fantasy Premier League Draft</p>
                    </div>
                    
                    <div className="config-section">
                        <h2>League Configuration</h2>
                        <div className="input-group">
                            <input 
                                type="text" 
                                placeholder="Enter League ID (e.g., 8308)"
                                value={leagueId}
                                onChange={(e) => setLeagueId(e.target.value)}
                            />
                            <button onClick={fetchLeagueData} disabled={loading}>
                                {loading ? 'Loading...' : 'Load League'}
                            </button>
                        </div>
                        <p style={{fontSize: '0.9rem', color: '#666', marginBottom: '10px'}}>
                            ℹ️ Note: This app uses a local proxy server to avoid authentication issues!
                        </p>
                        <button onClick={testConnection} style={{marginTop: '10px', background: '#28a745'}}>
                            Test API Connection
                        </button>
                    </div>
                    
                    {error && <div className={error.includes('✅') ? 'success' : 'error'}>{error}</div>}
                    
                    {loading && <div className="loading">Loading league data...</div>}
                    
                    {leagueData && !loading && (
                        <>
                            <div className="config-section">
                                <div className="gameweek-selector">
                                    <button onClick={() => changeGameweek(-1)} disabled={selectedGameweek <= 1}>
                                        ← Previous
                                    </button>
                                    <h2>Gameweek {selectedGameweek}</h2>
                                    <button onClick={() => changeGameweek(1)} disabled={selectedGameweek >= 38}>
                                        Next →
                                    </button>
                                </div>
                            </div>
                            
                            <div className="matchup-grid">
                                {matchups.map((matchup, idx) => {
                                    const team1Score = calculateTeamScore(matchup.entry1.picks, matchup.liveData);
                                    const team2Score = calculateTeamScore(matchup.entry2.picks, matchup.liveData);
                                    
                                    return (
                                        <div key={idx} className="matchup-card">
                                            <div className="matchup-header">
                                                <div>
                                                    <div className="team-name">{getTeamName(matchup.match.league_entry_1)}</div>
                                                    <div className="team-score">{team1Score}</div>
                                                </div>
                                                <div style={{fontSize: '2rem', color: '#ccc'}}>VS</div>
                                                <div style={{textAlign: 'right'}}>
                                                    <div className="team-name">{getTeamName(matchup.match.league_entry_2)}</div>
                                                    <div className="team-score">{team2Score}</div>
                                                </div>
                                            </div>
                                            
                                            <div className="matchup-content">
                                                <div className="team-lineup">
                                                    {matchup.entry1.picks.map((pick, i) => (
                                                        <div key={i} className="player-row">
                                                            <span className="player-name">
                                                                {getPlayerName(pick.element, matchup.liveData)}
                                                                {pick.multiplier > 1 && ' (C)'}
                                                            </span>
                                                            <span className="player-score">
                                                                {getPlayerScore(pick.element, matchup.liveData) * pick.multiplier}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                <div className="vs-divider">VS</div>
                                                
                                                <div className="team-lineup">
                                                    {matchup.entry2.picks.map((pick, i) => (
                                                        <div key={i} className="player-row">
                                                            <span className="player-name">
                                                                {getPlayerName(pick.element, matchup.liveData)}
                                                                {pick.multiplier > 1 && ' (C)'}
                                                            </span>
                                                            <span className="player-score">
                                                                {getPlayerScore(pick.element, matchup.liveData) * pick.multiplier}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            <div className="standings-card">
                                <h2>League Standings</h2>
                                <table className="standings-table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Team</th>
                                            <th>Manager</th>
                                            <th>Points</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {standings.map((team, idx) => (
                                            <tr key={idx}>
                                                <td className="rank">{team.rank}</td>
                                                <td>{team.entry_name}</td>
                                                <td>{team.player_name}</td>
                                                <td><strong>{team.total}</strong></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    )}
                </div>
            );
        };
        
        ReactDOM.render(<FPLDraftApp />, document.getElementById('root'));
    </script>
</body>
</html>
